name: Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  windows_x86:
    name: Test on Windows (x64)
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -c -DX86_WINDOWS -mssse3 -mpclmul -fPIC -O3 crc.c cpu_features.c
            gcc -shared crc.o cpu_features.o -o test/crc.dll
    - name: Run test
      run: python test/test.py

  mac_x86:
    name: Test on MacOS (x64)
    runs-on: macos-15-intel
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -c -DX86_NOT_WINDOWS -mssse3 -mpclmul -fPIC -O3 crc.c cpu_features.c
            gcc -dynamiclib crc.o cpu_features.o -o test/crc.dylib
    - name: Run test
      run: python test/test.py

  ubuntu_x86:
    name: Test on Ubuntu (x64)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -c -DX86_NOT_WINDOWS -mssse3 -mpclmul -fPIC -O3 crc.c cpu_features.c
            gcc -shared crc.o cpu_features.o -o test/crc.so
    - name: Run test
      run: python test/test.py

  mac_arm:
    name: Test on MacOS (ARM64)
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -c -DARMV8_OS_MACOS -fPIC -O3 crc.c cpu_features.c
            gcc -dynamiclib crc.o cpu_features.o -o test/crc.dylib
    - name: Run test
      run: python test/test.py

  ubuntu_arm:
    name: Test on Ubuntu (ARM64)
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -c -DARMV8_OS_LINUX -march=armv8-a+aes -fPIC -O3 crc.c cpu_features.c
            gcc -shared crc.o cpu_features.o -o test/crc.so
    - name: Run test
      run: python test/test.py

  no_simd:
    name: Test without SIMD
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Compile library
      run: |
            gcc -DCPU_NO_SIMD -c -fPIC -O3 crc.c cpu_features.c
            gcc -shared crc.o cpu_features.o -o test/crc.so
    - name: Run test
      run: python test/test.py