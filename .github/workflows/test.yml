name: Test

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  windows_x86:
    name: Test on Windows (x64)
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -mssse3 -mpclmul -fPIC -O3 crc.c
            gcc -shared crc.o -o test/crc.dll
    - name: Run test
      run: python test/test.py

  windows_arm:
    name: Test on Windows (ARM64)
    runs-on: windows-11-arm
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -fPIC -O3 crc.c
            gcc -shared crc.o -o test/crc.dll
    - name: Run test
      run: python test/test.py

  arm_mac:
    name: Test on MacOS (ARM64)
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -fPIC -O3 crc.c
            gcc -dynamiclib crc.o -o test/crc.dylib
    - name: Run test
      run: python test/test.py

  intel_mac:
    name: Test on MacOS (x64)
    runs-on: macos-15-intel
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -mssse3 -mpclmul -fPIC -O3 crc.c
            gcc -dynamiclib crc.o -o test/crc.dylib
    - name: Run test
      run: python test/test.py

  ubuntu_x86:
    name: Test on Ubuntu (x64)
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -mssse3 -mpclmul -fPIC -O3 crc.c
            gcc -shared crc.o -o test/crc.so
    - name: Run test
      run: python test/test.py

  ubuntu_arm:
    name: Test on Ubuntu (ARM64)
    runs-on: ubuntu-24.04-arm
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -c -march=armv8-a+aes -fPIC -O3 crc.c
            gcc -shared crc.o -o test/crc.so
    - name: Run test
      run: python test/test.py

  no_simd:
    name: Test without SIMD
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.14"
    - name: Compile library
      run: |
            gcc -DDISABLE_SIMD -c -fPIC -O3 crc.c
            gcc -shared crc.o -o test/crc.so
    - name: Run test
      run: python test/test.py